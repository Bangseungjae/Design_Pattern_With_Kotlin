# 팬아웃 패턴(Fan Out Fattern)

**팬아웃** 디자인 패턴은 작업을 여러 동시성 프로세서로 배분하기 위한 패턴이다. 이해를 돕기 위해 이전 절에서 다뤘던 예제에 다음과 같은 새로운 문제가 생겼다고 해보자.

만약 파이프라인의 처리 단계마다 수행해야 하는 작업의 양이 크게 다르다면?

예를 들어 HTML 문서를 파싱하는 것보다 네트워크를 통해 받아오는 데에 시간이 훨씬 오래 걸린다.이런 경우 오래 걸리는 작업을 여러 코루틴에 분배하기를 원할 수 있다. 앞의 예제에서는 코루틴 하나가 채널 하나를 읽어 들였다. 그러나 여러 코루틴이 하나의 채널을 읽는 것도 가능하다. 이렇게 하면 일감을 나눠서 처리할 수 있게 된다.

설명을 간단히 하기 위해 어떤 값을 생산하는 코루틴을 다음과 같이 하나만 만들어 보자.

```kotlin
fun CoroutineScope.generateWork(): ReceiveChannel<String> = produce {
    for (i in 1..10_000) {
        send("${i}쪽")
    }
    close()
}
```

그리고 다음 함수는 생산자가 값을 읽는 코루틴을 생성하는 역할을 한다.

```kotlin
fun CoroutineScope.doWork(
    id: Int,
    channel: ReceiveChannel<String>,
) = launch(Dispatchers.Default) {
    for (p in channel) {
        println("${id}번 일꾼이 ${p}을 처리")
    }
}
```

이 함수는 Default 분배기에서 실행되는 코루틴을 생성한다. 각 코루틴은 어떤 채널을 보고 있다가 값이 들어오면 콘솔에 그 값을 출력한다.

이제 생산자를 보자. 다음 코드는 모두 runBlocking 함수 안에 있어야 한다는 것을 기억하자. 하지만 여기서는 중요한 부분에 집중할 수 있도록 생략했다.

```kotlin
val workChannel = generateWork()
```

이제 다음과 같이 여러 일꾼이 같은 채널을 읽도록 하면 작업을 분배할 수 있게 된다.

```kotlin
val workers = List(10) { id ->
    doWork(id, workChannel)
}
```

이제 이 프로그램이 어떤 출력을 내는지 일부를 살펴보자.

```text
...
1번 일꾼이 9989쪽을 처리
7번 일꾼이 9985쪽을 처리
0번 일꾼이 9982쪽을 처리
9번 일꾼이 9977쪽을 처리
2번 일꾼이 9975쪽을 처리
4번 일꾼이 9976쪽을 처리
```

두 일꾼이 같은 메시지를 받는 일은 없다. 또한 전송 순서와 출력 순서가 일치하지 않는다는 점도 유념하라. 팬아웃 패턴은 작업을 여러 코루틴, 스레드, CPU에게 효율적으로 분배할 때 유용하게 사용할 수 있다.
